<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.yumcoach.community.model.mapper.CommunityMapper">

    <!-- ========== Post 관련 쿼리 ========== -->
    
    <!-- 게시글 목록 조회 (페이지네이션) -->
    <select id="selectAllPosts" resultType="com.ssafy.yumcoach.community.model.Post">
        SELECT 
            p.id,
            p.title,
            p.content,
            p.category,
            p.is_notice AS isNotice,
            p.is_deleted AS isDeleted,
            p.user_id AS userId,
            p.created_at AS createdAt,
            p.updated_at AS updatedAt,
            u.name AS userName,
            (SELECT COUNT(*) FROM comment c WHERE c.post_id = p.id AND c.is_deleted = 0) AS commentCount
        FROM post p
        LEFT JOIN user u ON p.user_id = u.id
        WHERE p.is_deleted = 0
        ORDER BY p.created_at DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 게시글 총 개수 -->
    <select id="selectPostCount" resultType="int">
        SELECT COUNT(*)
        FROM post
        WHERE is_deleted = 0
    </select>
    
    <!-- 게시글 상세 조회 -->
    <select id="selectPostById" resultType="com.ssafy.yumcoach.community.model.Post">
        SELECT 
            p.id,
            p.title,
            p.content,
            p.category,
            p.is_notice AS isNotice,
            p.is_deleted AS isDeleted,
            p.user_id AS userId,
            p.created_at AS createdAt,
            p.updated_at AS updatedAt,
            u.name AS userName
        FROM post p
        LEFT JOIN user u ON p.user_id = u.id
        WHERE p.id = #{id} AND p.is_deleted = 0
    </select>
    
    <!-- 게시글 작성 -->
    <insert id="insertPost" parameterType="com.ssafy.yumcoach.community.model.Post" 
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO post (
            title,
            content,
            category,
            is_notice,
            is_deleted,
            user_id,
            created_at
        ) VALUES (
            #{title},
            #{content},
            #{category},
            COALESCE(#{isNotice}, 0),
            0,
            #{userId},
            NOW()
        )
    </insert>
    
    <!-- 게시글 수정 -->
    <update id="updatePost">
        UPDATE post
        SET 
            title = #{title},
            content = #{content},
            updated_at = NOW()
        WHERE id = #{id}
    </update>
    
    <!-- 게시글 삭제 (소프트 삭제) -->
    <update id="deletePost">
        UPDATE post
        SET 
            is_deleted = 1,
            deleted_at = NOW(),
            deleted_by = #{deletedBy}
        WHERE id = #{id}
    </update>
    
    
    <!-- ========== Comment 관련 쿼리 ========== -->
    
    <!-- 댓글 목록 조회 -->
    <select id="selectCommentsByPostId" resultType="com.ssafy.yumcoach.community.model.Comment">
        SELECT 
            c.id,
            c.post_id AS postId,
            c.user_id AS userId,
            c.content,
            c.created_at AS createdAt,
            c.is_deleted AS isDeleted,
            u.name AS userName
        FROM comment c
        LEFT JOIN user u ON c.user_id = u.id
        WHERE c.post_id = #{postId} AND c.is_deleted = 0
        ORDER BY c.created_at ASC
    </select>
    
    <!-- 댓글 작성 -->
    <insert id="insertComment" parameterType="com.ssafy.yumcoach.community.model.Comment"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO comment (
            post_id,
            user_id,
            content,
            created_at,
            is_deleted
        ) VALUES (
            #{postId},
            #{userId},
            #{content},
            NOW(),
            0
        )
    </insert>
    
    <!-- 댓글 삭제 (소프트 삭제) -->
    <update id="deleteComment">
        UPDATE comment
        SET 
            is_deleted = 1,
            deleted_at = NOW()
        WHERE id = #{id}
    </update>

</mapper>
